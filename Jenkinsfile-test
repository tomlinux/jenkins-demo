#!groovy
def PrintMes(value, color) {
  colors = ['red'   : "\033[40;31m >>>>>>>>>>>${value}<<<<<<<<<<< \033[0m",
              'blue'  : "\033[47;34m ${value} \033[0m",
              'green' : "[1;32m>>>>>>>>>>${value}>>>>>>>>>>[m",
              'green1' : "\033[40;32m >>>>>>>>>>>${value}<<<<<<<<<<< \033[0m" ]
  ansiColor('xterm') {
        println(colors[color])
  }
}

pipeline {
  agent { node 'jenkins-slave' }
  options {
    timestamps()
  }
  environment {
    TimeStamp = "${currentBuild.startTimeInMillis}"
    Service = "${JOB_BASE_NAME}"
    BRANCH_NAME = 'master'
    //gitlab webhook å›žè°ƒåŠŸèƒ½
    Branch = "${env.gitlabTargetBranch}"
  }
  stages {
      stage('å…‹éš†ä»£ç ') {
        steps {
          PrintMes('1.ä»£ç å…‹éš†å’Œå‡†å¤‡é˜¶æ®µ', 'green')
          checkout scm
          script {
          BRANCH_NAME_TAG = sh(returnStdout: true, script: 'git rev-parse --abbrev-ref HEAD').trim()
          build_tag = sh(returnStdout: true, script: 'git rev-parse --short HEAD').trim()
          Branch_Name = 'master'
          if (Branch_Name != 'master') {
            build_tag = "${Branch_Name}-${build_tag}"
          }
          println("build_tagçš„å€¼æ˜¯ï¼š${build_tag}")
          }
        }
      }
      stage('æµ‹è¯•é¡¹ç›®') {
        steps {
          input 'ç¡®è®¤è¦éƒ¨ç½²çº¿ä¸ŠçŽ¯å¢ƒå—ï¼Ÿ'
          PrintMes('2.æµ‹è¯•é¡¹ç›®', 'green')
        }
      }
      stage('æž„å»ºé•œåƒ') {
      steps {
            PrintMes('3.æž„å»ºdockerå®¹å™¨', 'green')
            timeout(time: 1, unit: 'MINUTES') {
              script {
                env.DEPLOY_ENV = input message: 'é€‰æ‹©éƒ¨ç½²çš„çŽ¯å¢ƒ', ok: 'deploy',
                      parameters: [choice(name: 'DEPLOY_ENV', choices: ['prd', 'uat', 'test'], description: 'é€‰æ‹©éƒ¨ç½²çŽ¯å¢ƒ')]
                switch ("${env.DEPLOY_ENV}") {
                case 'prd':
                    println('deploy prd env')
                    break
                case 'uat':
                    println('deploy uat env')
                    break
                case 'test':
                    println('deploy test env')
                    break
                default:
                    println('error env')
                }
              }
            }
      }
      }
      stage('ä¸Šä¼ é•œåƒ') {
      steps {
          PrintMes('4.æŽ¨é€dockeré•œåƒåº“', 'green')
      }
      }
      stage('å‘å¸ƒ') {
          steps {
            PrintMes('5. å‘å¸ƒk8s yaml', 'green')
          }
      }
  }
}
